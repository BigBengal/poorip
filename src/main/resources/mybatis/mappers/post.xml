<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="post">

	<insert id="insert" parameterType="postvo">
		<![CDATA[
			INSERT 
			  INTO POST (POST_SEQ,  title, contents,  REVIEW_PUB_YN,  USR_SEQ,  TRV_SEQ)
			values ( #{postSeq}, #{title}, #{contents}, #{reviewPubYn}, #{usrSeq}, #{trvSeq} )
		]]>
	</insert>

	<insert id="addPost" parameterType="reviewvo">
		<selectKey keyProperty="postSeq" resultType="integer" order="BEFORE">
			<![CDATA[
			select auto_increment
			  from information_schema.tables
			 where table_schema='bengal'
			   and table_name='post'
			]]>
		</selectKey>
		<![CDATA[
			insert into
				post 
				values(#{postSeq },
						#{title }, 
						#{contents }, 
						#{reviewPubYn },
						#{usrSeq }, 
						#{trvSeq },
						now(),
						#{hidden })
		]]>
	</insert>

	<select id="getPostList" resultType="postvo">
	    <![CDATA[
			SELECT POST_SEQ as postSeq,
			       TITLE as title,
			       CONTENTS as contents, 
			       REVIEW_PUB_YN as reviewPubYn, 
			       USR_SEQ as usrSeq, 
			       TRV_SEQ as trvSeq
			  FROM POST
		]]>
	</select>

	<select id="getUserPostList" resultType="reviewvo"
		parameterType="map">
	    <![CDATA[
			select p.post_seq as postSeq,
				   title,
				   contents,
				   p.usr_seq as usrSeq,
				   p.crt_date as crtDate
				from post p, users u
			where p.USR_SEQ = u.USR_SEQ
			  and p.usr_seq = #{usrSeq }
	order by p.crt_date desc
		limit #{page}, 3
		]]>
	</select>

	<select id="getTotalCounts" resultType="integer" parameterType="integer">
	    <![CDATA[
			select count(*)
		  		from post
		  	where usr_seq = #{usrSeq }
		]]>
	</select>

	<select id="getReviewsByLikes" resultType="reviewvo" parameterType="integer">
	    <![CDATA[
		select	c.post_seq as postSeq, 
				count(c.post_seq) as likeCount, 
				   b.title as title, 
				   b.contents as contents, 
				   b.CRT_DATE as crtDate, 
				   b.TRV_SEQ as trvSeq
	from travel_info a, post b, post_like c 
	where a.TRV_SEQ = b.TRV_SEQ 
	and b.`POST_SEQ` = c.post_seq and a.trv_seq =#{trvSeq}
	and b.REVIEW_PUB_YN='Y' 
	group by  c.post_seq order by count(c.post_seq) desc
	]]>
	</select>

	<select id="selectbyno" resultType="postvo" parameterType="integer">
		<![CDATA[
			SELECT POST_SEQ as postSeq,
			       TITLE as title,
			       CONTENTS as contents, 
			       REVIEW_PUB_YN as reviewPubYn, 
			       USR_SEQ as usrSeq, 
			       TRV_SEQ as trvSeq
			  FROM POST
			 WHERE POST_SEQ = #{postSeq }
		]]>
	</select>

	<!-- <select id="selectbytravelseq" resultType="postvo" parameterType="integer"> 
		<![CDATA[ SELECT POST_SEQ as postSeq, TITLE as title, CONTENTS as contents, 
		REVIEW_PUB_YN as reviewPubYn, USR_SEQ as usrSeq, TRV_SEQ as trvSeq, CRT_DATE 
		as crtDate FROM POST WHERE TRV_SEQ = #{trvSeq } AND REVIEW_PUB_YN = 'Y' ]]> 
		</select> -->

	<select id="selectbytravelseq" resultType="reviewvo"
		parameterType="integer">
		<![CDATA[
			select a.POST_SEQ as postSeq, 
					count(c.post_seq) as likeCount,
				   a.title as title, 
				   a.contents as contents, 
				   a.CRT_DATE as crtDate, 
				   a.TRV_SEQ as trvSeq 
					   from post a, travel_info b, post_like c  
					   where a.TRV_SEQ = b.trv_seq 
					   and a.POST_SEQ = c.post_seq 
					   and a.REVIEW_PUB_YN='Y' and b.trv_seq=#{trvSeq}				
				   group by  c.post_seq order by crtDate desc;
		]]>
	</select>

	<select id="getAddPostList" resultType="reviewvo" parameterType="integer">
		<![CDATA[
			select p.post_seq as postSeq,
				   title,
				   contents,
				   path,
				   file_name as fileName,
				   p.crt_date as crtDate
				   		from post p, post_pic pp
			   where p.post_seq = pp.post_seq
				  and p.usr_seq = #{usrSeq }
			      and pp.post_seq = (select max(post.post_seq) as postSeq
				  									from post post, post_pic postpic
										where post.POST_SEQ = postpic.POST_SEQ
										  and post.usr_seq = #{usrSeq })
		]]>
	</select>

	<delete id="delete" parameterType="postvo">
		<![CDATA[
			DELETE 
			  FROM POST
			 WHERE POST_SEQ = #{postSeq }
		]]>
	</delete>

	<select id="getPostListbyPoolSeq" resultType="reviewvo"
		parameterType="map">
		<![CDATA[
			select p.post_seq as postSeq,
				   title,
				   contents,
				   p.usr_seq as usrSeq,
				   p.crt_date as crtDate
			 from post p, pool_post pp
			where p.POST_SEQ = pp.POST_SEQ
			  and pp.POOL_SEQ = #{poolSeq }
			order by p.crt_date desc
			limit #{page}, 5
		]]>
	</select>


	<update id="increasePostLike" parameterType="map">
		<![CDATA[
	insert into post_like values(null, #{postSeq}, #{usrSeq}, now())
	]]>
	</update>

	<select id="checkPostLike" resultType="Integer" parameterType="map">
		<![CDATA[
	select ifnull(post_seq, 0) as postSeq from post_like where usr_seq=#{usrSeq} and post_seq=#{postSeq}		
		]]>
	</select>


	<delete id="decreasePostLike" parameterType="map">
		<![CDATA[
	delete from post_like where usr_seq=#{usrSeq} and post_seq=#{postSeq}
	]]>
	</delete>

	<select id="selectPostLike" resultType="postvo" parameterType="map">
		<![CDATA[
	select a.post_seq as postSeq 
	from post a, post_like b 
	where a.POST_SEQ = b.post_seq and trv_seq=#{trvSeq} and b.usr_seq=#{usrSeq}
	]]>
	</select>

	<select id="selectAllPostSeqOfTravelInfo" resultType="postvo"
		parameterType="integer">
	<![CDATA[
	select post_seq from post where trv_seq=#{trvSeq}
	]]>
	</select>

</mapper>
